<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dispatch Earnings Calculator</title>
    <link rel="stylesheet" href="rate_calculator.css" />
  </head>
  <body>
    <main class="calculator">
      <header class="calculator__header">
        <h1>Dispatch Earnings Calculator</h1>
        <p>
          Enter the miles and payout for a load to see how much the dispatch team
          should receive.
        </p>
      </header>

      <form id="calculator-form" class="calculator__form" autocomplete="off">
        <label class="calculator__label" for="amount">
          Load payout (USD)
          <input
            id="amount"
            name="amount"
            type="number"
            min="0"
            step="0.01"
            placeholder="e.g. 1350.00"
            required
          />
        </label>

        <label class="calculator__label" for="miles">
          Miles driven
          <input
            id="miles"
            name="miles"
            type="number"
            min="0"
            step="1"
            placeholder="e.g. 475"
            required
          />
        </label>

        <button type="submit">Calculate earnings</button>
      </form>

      <section class="calculator__result" aria-live="polite">
        <p id="result-message">Enter load details to calculate earnings.</p>
        <p id="rate-formula" class="calculator__formula" hidden></p>
        <p id="result-formula" class="calculator__formula" hidden></p>
        <p id="result-explanation" class="calculator__explanation" hidden></p>
      </section>

      <section class="calculator__history" aria-live="polite">
        <div class="calculator__history-header">
          <h2>Saved calculations</h2>
          <button type="button" id="reset-history" class="calculator__reset" disabled>
            Reset
          </button>
        </div>
        <div id="history-sections" class="calculator__sections"></div>
        <div class="calculator__overall">
          <span>Total earnings (all weeks)</span>
          <span id="history-total">$0.00</span>
        </div>
        <div class="calculator__history-actions">
          <button type="button" id="new-section" class="calculator__new-section">
            Start new week
          </button>
          <button type="button" id="download-xlsx" class="calculator__download">
            Download Excel
          </button>
        </div>
      </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
    <script>
      const form = document.getElementById('calculator-form');
      const resultMessage = document.getElementById('result-message');
      const rateFormula = document.getElementById('rate-formula');
      const resultFormula = document.getElementById('result-formula');
      const resultExplanation = document.getElementById('result-explanation');
      const historySections = document.getElementById('history-sections');
      const historyTotal = document.getElementById('history-total');
      const resetHistoryButton = document.getElementById('reset-history');
      const newSectionButton = document.getElementById('new-section');
      const downloadXlsxButton = document.getElementById('download-xlsx');

      const MAX_RATE = 0.1;
      const MIN_RATE = 0.03;
      const RATE_THRESHOLD = 500;
      const RATE_SLOPE = (MAX_RATE - MIN_RATE) / RATE_THRESHOLD;
      const STORAGE_KEY = 'dispatch-calculator-history';

      function formatCurrency(value) {
        return value.toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });
      }

      function formatNumber(value) {
        return value.toLocaleString('en-US', { maximumFractionDigits: 0 });
      }

      function applyRowStyle(row, style) {
        row.eachCell({ includeEmpty: true }, (cell) => {
          if (style.fill) {
            cell.fill = {
              type: 'pattern',
              pattern: 'solid',
              fgColor: { argb: style.fill },
            };
          }
          if (style.font) {
            cell.font = style.font;
          }
          if (style.alignment) {
            cell.alignment = style.alignment;
          }
          if (style.border) {
            cell.border = style.border;
          }
        });
      }

      function buildWorkbook(sections) {
        const workbook = new ExcelJS.Workbook();
        workbook.creator = 'Dispatch Earnings Calculator';
        const sheet = workbook.addWorksheet('Dispatch Calculations');
        sheet.columns = [
          { key: 'item', width: 18 },
          { key: 'payout', width: 14 },
          { key: 'miles', width: 10 },
          { key: 'rate', width: 10 },
          { key: 'earnings', width: 14 },
          { key: 'avg', width: 14 },
        ];

        const headerFill = 'FFCCE6FF';
        const weekFill = 'FFEDE2FF';
        const totalFill = 'FFDFF5E1';
        const overallFill = 'FFFFE3B3';
        const loadFillA = 'FFF7FAFF';
        const loadFillB = 'FFF0F6FF';
        const thinBorder = {
          top: { style: 'thin', color: { argb: 'FFD9E2F2' } },
          left: { style: 'thin', color: { argb: 'FFD9E2F2' } },
          bottom: { style: 'thin', color: { argb: 'FFD9E2F2' } },
          right: { style: 'thin', color: { argb: 'FFD9E2F2' } },
        };

        let overallEarnings = 0;
        let overallPayout = 0;
        let overallMiles = 0;
        sections.forEach((section, index) => {
          const weekLabel = `Week ${index + 1}`;
          const weekPayout = section.entries.reduce(
            (sum, entry) => sum + entry.amount,
            0
          );
          const weekMiles = section.entries.reduce(
            (sum, entry) => sum + entry.miles,
            0
          );
          const weekEarnings = section.entries.reduce(
            (sum, entry) => sum + entry.earnings,
            0
          );
          const weekAvgPerMile = weekMiles > 0 ? weekPayout / weekMiles : 0;
          overallEarnings += weekEarnings;
          overallPayout += weekPayout;
          overallMiles += weekMiles;
          const weekRow = sheet.addRow([weekLabel]);
          sheet.mergeCells(weekRow.number, 1, weekRow.number, 6);
          applyRowStyle(weekRow, {
            fill: weekFill,
            font: { bold: true },
            alignment: { vertical: 'middle', horizontal: 'left' },
            border: thinBorder,
          });

          const headerRow = sheet.addRow([
            'Item',
            'Payout',
            'Miles',
            'Rate',
            'Earnings',
            'Avg $/mile',
          ]);
          applyRowStyle(headerRow, {
            fill: headerFill,
            font: { bold: true },
            border: thinBorder,
          });

          if (!section.entries.length) {
            const emptyRow = sheet.addRow(['No entries']);
            sheet.mergeCells(emptyRow.number, 1, emptyRow.number, 6);
            applyRowStyle(emptyRow, {
              alignment: { vertical: 'middle', horizontal: 'left' },
            });
          } else {
            section.entries.forEach((entry, entryIndex) => {
              const entryAvgPerMile = entry.miles > 0 ? entry.amount / entry.miles : 0;
              const entryRow = sheet.addRow([
                `Load ${entryIndex + 1}`,
                entry.amount,
                entry.miles,
                entry.rate,
                entry.earnings,
                entryAvgPerMile,
              ]);
              entryRow.getCell(2).numFmt = '$#,##0.00';
              entryRow.getCell(3).numFmt = '#,##0';
              entryRow.getCell(4).numFmt = '0.00%';
              entryRow.getCell(5).numFmt = '$#,##0.00';
              entryRow.getCell(6).numFmt = '$#,##0.00';
              applyRowStyle(entryRow, {
                fill: entryIndex % 2 === 0 ? loadFillA : loadFillB,
                border: thinBorder,
              });
            });
          }

          const totalRow = sheet.addRow([
            'Week total',
            weekPayout,
            weekMiles,
            '',
            weekEarnings,
            weekAvgPerMile,
          ]);
          totalRow.getCell(2).numFmt = '$#,##0.00';
          totalRow.getCell(3).numFmt = '#,##0';
          totalRow.getCell(5).numFmt = '$#,##0.00';
          totalRow.getCell(6).numFmt = '$#,##0.00';
          applyRowStyle(totalRow, {
            fill: totalFill,
            font: { bold: true },
            border: thinBorder,
          });
          sheet.addRow([]);
        });
        if (sections.length) {
          const overallAvgPerMile = overallMiles > 0 ? overallPayout / overallMiles : 0;
          const overallRow = sheet.addRow([
            'All weeks total',
            overallPayout,
            overallMiles,
            '',
            overallEarnings,
            overallAvgPerMile,
          ]);
          overallRow.getCell(2).numFmt = '$#,##0.00';
          overallRow.getCell(3).numFmt = '#,##0';
          overallRow.getCell(5).numFmt = '$#,##0.00';
          overallRow.getCell(6).numFmt = '$#,##0.00';
          applyRowStyle(overallRow, {
            fill: overallFill,
            font: { bold: true },
            border: thinBorder,
          });
        }
        return workbook;
      }

      function loadHistory() {
        try {
          const stored = JSON.parse(localStorage.getItem(STORAGE_KEY));
          if (Array.isArray(stored)) {
            if (stored.length && stored[0]?.entries) {
              return stored;
            }
            return [{ id: `section-${Date.now()}`, entries: stored }];
          }
          return [];
        } catch (error) {
          return [];
        }
      }

      function saveHistory(entries) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
      }

      function renderHistory(sections) {
        historySections.innerHTML = '';

        if (!sections.length) {
          historyTotal.textContent = formatCurrency(0);
          resetHistoryButton.disabled = true;
          return;
        }

        let overallTotal = 0;
        sections.forEach((section, index) => {
          const sectionTotal = section.entries.reduce(
            (sum, entry) => sum + entry.earnings,
            0
          );
          overallTotal += sectionTotal;

          const sectionEl = document.createElement('div');
          sectionEl.className =
            section.id === activeSectionId
              ? 'calculator__section calculator__section--active'
              : 'calculator__section';
          sectionEl.dataset.sectionId = section.id;

          const sectionHeader = document.createElement('div');
          sectionHeader.className = 'calculator__section-header';
          sectionHeader.innerHTML = `
            <h3>Week ${index + 1}</h3>
            <button type="button" class="calculator__edit" data-section="${section.id}">
              Edit
            </button>
          `;

          const tableWrapper = document.createElement('div');
          tableWrapper.className = 'calculator__table-wrapper';
          const table = document.createElement('table');
          table.className = 'calculator__table';
          table.setAttribute('aria-label', `Calculation history week ${index + 1}`);
          table.innerHTML = `
            <thead>
              <tr>
                <th>Payout</th>
                <th>Miles</th>
                <th>Rate</th>
                <th>Earnings</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;

          const tbody = table.querySelector('tbody');
          if (!section.entries.length) {
            const emptyRow = document.createElement('tr');
            const emptyCell = document.createElement('td');
            emptyCell.colSpan = 5;
            emptyCell.textContent = 'No saved calculations in this week yet.';
            emptyCell.className = 'calculator__empty';
            emptyRow.appendChild(emptyCell);
            tbody.appendChild(emptyRow);
          } else {
            section.entries.forEach((entry) => {
              const row = document.createElement('tr');
              row.className = 'calculator__row';
              row.draggable = true;
              row.dataset.id = entry.id;
              row.dataset.section = section.id;
              row.innerHTML = `
                <td>${formatCurrency(entry.amount)}</td>
                <td>${formatNumber(entry.miles)}</td>
                <td>${(entry.rate * 100).toFixed(2)}%</td>
                <td>${formatCurrency(entry.earnings)}</td>
                <td>
                  <button type="button" class="calculator__delete" data-id="${entry.id}" data-section="${section.id}">
                    -
                  </button>
                </td>
              `;
              tbody.appendChild(row);
            });
          }

          const sectionTotalEl = document.createElement('div');
          sectionTotalEl.className = 'calculator__total';
          sectionTotalEl.innerHTML = `
            <span>Total earnings</span>
            <span>${formatCurrency(sectionTotal)}</span>
          `;

          tableWrapper.appendChild(table);
          sectionEl.appendChild(sectionHeader);
          sectionEl.appendChild(tableWrapper);
          sectionEl.appendChild(sectionTotalEl);
          historySections.appendChild(sectionEl);
        });

        historyTotal.textContent = formatCurrency(overallTotal);
        resetHistoryButton.disabled = overallTotal === 0;
      }

      let historySectionsData = loadHistory();
      if (!historySectionsData.length) {
        historySectionsData = [{ id: `section-${Date.now()}`, entries: [] }];
      }
      let activeSectionId =
        historySectionsData[historySectionsData.length - 1]?.id;
      let dragState = null;
      renderHistory(historySectionsData);

      function calculateRate(miles) {
        const clampedMiles = Math.max(0, miles);

        if (clampedMiles >= RATE_THRESHOLD) {
          return {
            rate: MIN_RATE,
            formula: `Rate formula: ${(MIN_RATE * 100).toFixed(
              0
            )}% flat for loads at or above ${RATE_THRESHOLD} miles.`,
            details: {
              type: 'flat',
              threshold: RATE_THRESHOLD,
              flatPercent: (MIN_RATE * 100).toFixed(0),
            },
          };
        }

        const rate = MAX_RATE - RATE_SLOPE * clampedMiles;
        const maxRatePercent = (MAX_RATE * 100).toFixed(0);
        const slopePercent = (RATE_SLOPE * 100).toFixed(3);
        const milesRounded = clampedMiles.toFixed(0);
        const computedPercent = (rate * 100).toFixed(2);

        return {
          rate,
          formula: `Rate formula: ${maxRatePercent}% - (${slopePercent}% × ${milesRounded}) ≈ ${computedPercent}%.`,
          details: {
            type: 'slope',
            basePercent: maxRatePercent,
            slopePercent,
            milesRounded,
            computedPercent,
          },
        };
      }

      form.addEventListener('submit', (event) => {
        event.preventDefault();

        const miles = Number(form.miles.value);
        const amount = Number(form.amount.value);

        if (!Number.isFinite(miles) || miles < 0) {
          resultMessage.textContent = 'Please enter a valid non-negative value for miles.';
          rateFormula.hidden = true;
          resultFormula.hidden = true;
          resultExplanation.hidden = true;
          return;
        }

        if (!Number.isFinite(amount) || amount < 0) {
          resultMessage.textContent = 'Please enter a valid non-negative value for the payout.';
          rateFormula.hidden = true;
          resultFormula.hidden = true;
          resultExplanation.hidden = true;
          return;
        }

        const { rate, formula, details } = calculateRate(miles);
        const earnings = amount * rate;

        const formattedEarnings = formatCurrency(earnings);
        const formattedAmount = formatCurrency(amount);
        const formattedRate = (rate * 100).toFixed(2);

        resultMessage.textContent = `Dispatch earnings: ${formattedEarnings} at a ${formattedRate}% rate.`;
        rateFormula.textContent = formula;
        resultFormula.textContent = `Formula: ${formattedAmount} × ${formattedRate}% = ${formattedEarnings}`;
        if (details?.type === 'slope') {
          resultExplanation.textContent = `Explanation: Start at ${details.basePercent}% for a zero-mile trip. Subtract ${details.slopePercent}% for every mile. With ${details.milesRounded} miles: ${details.basePercent}% - (${details.slopePercent}% × ${details.milesRounded}) ≈ ${details.computedPercent}%.`;
        } else {
          resultExplanation.textContent = `Explanation: Trips of ${details.threshold} miles or more always use a flat ${details.flatPercent}% rate—no per-mile reduction.`;
        }
        rateFormula.hidden = false;
        resultFormula.hidden = false;
        resultExplanation.hidden = false;

        const newEntry = {
          id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
          miles,
          amount,
          rate,
          earnings,
        };
        const currentSection =
          historySectionsData.find((section) => section.id === activeSectionId) ||
          historySectionsData[historySectionsData.length - 1];
        activeSectionId = currentSection.id;
        currentSection.entries = [newEntry, ...currentSection.entries];
        saveHistory(historySectionsData);
        renderHistory(historySectionsData);
      });

      historySections.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        if (target.classList.contains('calculator__edit')) {
          const sectionId = target.dataset.section;
          activeSectionId = sectionId;
          renderHistory(historySectionsData);
          return;
        }
        if (!target.classList.contains('calculator__delete')) {
          return;
        }
        const id = target.dataset.id;
        const sectionId = target.dataset.section;
        const section = historySectionsData.find((item) => item.id === sectionId);
        if (!section) {
          return;
        }
        section.entries = section.entries.filter((entry) => entry.id !== id);
        saveHistory(historySectionsData);
        renderHistory(historySectionsData);
      });

      resetHistoryButton.addEventListener('click', () => {
        const shouldReset = window.confirm(
          'Delete all calculations and weeks? This cannot be undone.'
        );
        if (!shouldReset) {
          return;
        }
        historySectionsData = [{ id: `section-${Date.now()}`, entries: [] }];
        activeSectionId = historySectionsData[0].id;
        saveHistory(historySectionsData);
        renderHistory(historySectionsData);
      });

      historySections.addEventListener('dragstart', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        const row = target.closest('tr');
        if (!row || !row.dataset.id || !row.dataset.section) {
          return;
        }
        dragState = {
          entryId: row.dataset.id,
          sectionId: row.dataset.section,
        };
        row.classList.add('calculator__row--dragging');
        if (event.dataTransfer) {
          event.dataTransfer.effectAllowed = 'move';
          event.dataTransfer.setData('text/plain', row.dataset.id);
        }
      });

      historySections.addEventListener('dragend', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        const row = target.closest('tr');
        if (row) {
          row.classList.remove('calculator__row--dragging');
        }
        historySections.querySelectorAll('.calculator__row--over').forEach((item) => {
          item.classList.remove('calculator__row--over');
        });
        dragState = null;
      });

      historySections.addEventListener('dragover', (event) => {
        if (!dragState) {
          return;
        }
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        const sectionElement = target.closest('.calculator__section');
        if (!sectionElement || sectionElement.dataset.sectionId !== dragState.sectionId) {
          return;
        }
        const row = target.closest('tr');
        if (row && row.dataset.section === dragState.sectionId) {
          event.preventDefault();
          historySections.querySelectorAll('.calculator__row--over').forEach((item) => {
            item.classList.remove('calculator__row--over');
          });
          row.classList.add('calculator__row--over');
        } else {
          const tbody = target.closest('tbody');
          if (tbody) {
            event.preventDefault();
          }
        }
      });

      historySections.addEventListener('dragleave', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        const row = target.closest('tr');
        if (row) {
          row.classList.remove('calculator__row--over');
        }
      });

      historySections.addEventListener('drop', (event) => {
        if (!dragState) {
          return;
        }
        event.preventDefault();
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        const sectionElement = target.closest('.calculator__section');
        if (!sectionElement || sectionElement.dataset.sectionId !== dragState.sectionId) {
          return;
        }
        const section = historySectionsData.find(
          (item) => item.id === dragState.sectionId
        );
        if (!section) {
          return;
        }
        const fromIndex = section.entries.findIndex(
          (entry) => entry.id === dragState.entryId
        );
        if (fromIndex === -1) {
          return;
        }

        const row = target.closest('tr');
        let targetId = null;
        if (row && row.dataset.section === dragState.sectionId) {
          targetId = row.dataset.id;
          row.classList.remove('calculator__row--over');
        }

        if (targetId === dragState.entryId) {
          return;
        }

        const [moved] = section.entries.splice(fromIndex, 1);
        let insertIndex = section.entries.length;
        if (targetId) {
          const targetIndex = section.entries.findIndex(
            (entry) => entry.id === targetId
          );
          if (targetIndex !== -1) {
            insertIndex = targetIndex;
          }
        }
        section.entries.splice(insertIndex, 0, moved);
        saveHistory(historySectionsData);
        renderHistory(historySectionsData);
      });

      newSectionButton.addEventListener('click', () => {
        const newSection = { id: `section-${Date.now()}`, entries: [] };
        historySectionsData.push(newSection);
        activeSectionId = newSection.id;
        saveHistory(historySectionsData);
        renderHistory(historySectionsData);
      });

      downloadXlsxButton.addEventListener('click', async () => {
        if (typeof ExcelJS === 'undefined') {
          window.alert('Excel export is not available right now. Please reload the page.');
          return;
        }
        const workbook = buildWorkbook(historySectionsData);
        try {
          const buffer = await workbook.xlsx.writeBuffer();
          const blob = new Blob([buffer], {
            type:
              'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
          });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = 'dispatch-calculations.xlsx';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        } catch (error) {
          window.alert('Could not generate the Excel file. Please try again.');
        }
      });
    </script>
  </body>
</html>
