<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dispatch Earnings Calculator</title>
    <link rel="stylesheet" href="rate_calculator.css" />
  </head>
  <body>
    <main class="calculator">
      <header class="calculator__header">
        <h1>Dispatch Earnings Calculator</h1>
        <p>
          Enter the miles and payout for a load to see how much the dispatch team
          should receive.
        </p>
      </header>

      <form id="calculator-form" class="calculator__form" autocomplete="off">
        <label class="calculator__label" for="amount">
          Load payout (USD)
          <input
            id="amount"
            name="amount"
            type="number"
            min="0"
            step="0.01"
            placeholder="e.g. 1350.00"
            required
          />
        </label>

        <label class="calculator__label" for="miles">
          Miles driven
          <input
            id="miles"
            name="miles"
            type="number"
            min="0"
            step="1"
            placeholder="e.g. 475"
            required
          />
        </label>

        <button type="submit">Calculate earnings</button>
      </form>

      <section class="calculator__result" aria-live="polite">
        <p id="result-message">Enter load details to calculate earnings.</p>
        <p id="rate-formula" class="calculator__formula" hidden></p>
        <p id="result-formula" class="calculator__formula" hidden></p>
        <p id="result-explanation" class="calculator__explanation" hidden></p>
      </section>

      <section class="calculator__history" aria-live="polite">
        <div class="calculator__history-header">
          <h2>Saved calculations</h2>
          <button type="button" id="reset-history" class="calculator__reset" disabled>
            Reset
          </button>
        </div>
        <div class="calculator__table-wrapper">
          <table class="calculator__table" aria-label="Calculation history">
            <thead>
              <tr>
                <th>Payout</th>
                <th>Miles</th>
                <th>Rate</th>
                <th>Earnings</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="history-body"></tbody>
          </table>
        </div>
        <div class="calculator__total">
          <span>Total earnings</span>
          <span id="history-total">$0.00</span>
        </div>
      </section>
    </main>

    <script>
      const form = document.getElementById('calculator-form');
      const resultMessage = document.getElementById('result-message');
      const rateFormula = document.getElementById('rate-formula');
      const resultFormula = document.getElementById('result-formula');
      const resultExplanation = document.getElementById('result-explanation');
      const historyBody = document.getElementById('history-body');
      const historyTotal = document.getElementById('history-total');
      const resetHistoryButton = document.getElementById('reset-history');

      const MAX_RATE = 0.1;
      const MIN_RATE = 0.03;
      const RATE_THRESHOLD = 500;
      const RATE_SLOPE = (MAX_RATE - MIN_RATE) / RATE_THRESHOLD;
      const STORAGE_KEY = 'dispatch-calculator-history';

      function formatCurrency(value) {
        return value.toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });
      }

      function formatNumber(value) {
        return value.toLocaleString('en-US', { maximumFractionDigits: 0 });
      }

      function loadHistory() {
        try {
          const stored = JSON.parse(localStorage.getItem(STORAGE_KEY));
          return Array.isArray(stored) ? stored : [];
        } catch (error) {
          return [];
        }
      }

      function saveHistory(entries) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
      }

      function renderHistory(entries) {
        historyBody.innerHTML = '';

        if (!entries.length) {
          const emptyRow = document.createElement('tr');
          const emptyCell = document.createElement('td');
          emptyCell.colSpan = 5;
          emptyCell.textContent = 'No saved calculations yet.';
          emptyCell.className = 'calculator__empty';
          emptyRow.appendChild(emptyCell);
          historyBody.appendChild(emptyRow);
          historyTotal.textContent = formatCurrency(0);
          resetHistoryButton.disabled = true;
          return;
        }

        let total = 0;
        entries.forEach((entry) => {
          total += entry.earnings;
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${formatCurrency(entry.amount)}</td>
            <td>${formatNumber(entry.miles)}</td>
            <td>${(entry.rate * 100).toFixed(2)}%</td>
            <td>${formatCurrency(entry.earnings)}</td>
            <td>
              <button type="button" class="calculator__delete" data-id="${entry.id}">
                -
              </button>
            </td>
          `;
          historyBody.appendChild(row);
        });

        historyTotal.textContent = formatCurrency(total);
        resetHistoryButton.disabled = false;
      }

      let historyEntries = loadHistory();
      renderHistory(historyEntries);

      function calculateRate(miles) {
        const clampedMiles = Math.max(0, miles);

        if (clampedMiles >= RATE_THRESHOLD) {
          return {
            rate: MIN_RATE,
            formula: `Rate formula: ${(MIN_RATE * 100).toFixed(
              0
            )}% flat for loads at or above ${RATE_THRESHOLD} miles.`,
            details: {
              type: 'flat',
              threshold: RATE_THRESHOLD,
              flatPercent: (MIN_RATE * 100).toFixed(0),
            },
          };
        }

        const rate = MAX_RATE - RATE_SLOPE * clampedMiles;
        const maxRatePercent = (MAX_RATE * 100).toFixed(0);
        const slopePercent = (RATE_SLOPE * 100).toFixed(3);
        const milesRounded = clampedMiles.toFixed(0);
        const computedPercent = (rate * 100).toFixed(2);

        return {
          rate,
          formula: `Rate formula: ${maxRatePercent}% - (${slopePercent}% × ${milesRounded}) ≈ ${computedPercent}%.`,
          details: {
            type: 'slope',
            basePercent: maxRatePercent,
            slopePercent,
            milesRounded,
            computedPercent,
          },
        };
      }

      form.addEventListener('submit', (event) => {
        event.preventDefault();

        const miles = Number(form.miles.value);
        const amount = Number(form.amount.value);

        if (!Number.isFinite(miles) || miles < 0) {
          resultMessage.textContent = 'Please enter a valid non-negative value for miles.';
          rateFormula.hidden = true;
          resultFormula.hidden = true;
          resultExplanation.hidden = true;
          return;
        }

        if (!Number.isFinite(amount) || amount < 0) {
          resultMessage.textContent = 'Please enter a valid non-negative value for the payout.';
          rateFormula.hidden = true;
          resultFormula.hidden = true;
          resultExplanation.hidden = true;
          return;
        }

        const { rate, formula, details } = calculateRate(miles);
        const earnings = amount * rate;

        const formattedEarnings = formatCurrency(earnings);
        const formattedAmount = formatCurrency(amount);
        const formattedRate = (rate * 100).toFixed(2);

        resultMessage.textContent = `Dispatch earnings: ${formattedEarnings} at a ${formattedRate}% rate.`;
        rateFormula.textContent = formula;
        resultFormula.textContent = `Formula: ${formattedAmount} × ${formattedRate}% = ${formattedEarnings}`;
        if (details?.type === 'slope') {
          resultExplanation.textContent = `Explanation: Start at ${details.basePercent}% for a zero-mile trip. Subtract ${details.slopePercent}% for every mile. With ${details.milesRounded} miles: ${details.basePercent}% - (${details.slopePercent}% × ${details.milesRounded}) ≈ ${details.computedPercent}%.`;
        } else {
          resultExplanation.textContent = `Explanation: Trips of ${details.threshold} miles or more always use a flat ${details.flatPercent}% rate—no per-mile reduction.`;
        }
        rateFormula.hidden = false;
        resultFormula.hidden = false;
        resultExplanation.hidden = false;

        const newEntry = {
          id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
          miles,
          amount,
          rate,
          earnings,
        };
        historyEntries = [newEntry, ...historyEntries];
        saveHistory(historyEntries);
        renderHistory(historyEntries);
      });

      historyBody.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        if (!target.classList.contains('calculator__delete')) {
          return;
        }
        const id = target.dataset.id;
        historyEntries = historyEntries.filter((entry) => entry.id !== id);
        saveHistory(historyEntries);
        renderHistory(historyEntries);
      });

      resetHistoryButton.addEventListener('click', () => {
        historyEntries = [];
        saveHistory(historyEntries);
        renderHistory(historyEntries);
      });
    </script>
  </body>
</html>
